{
  "name": "Register Patient response",
  "endpoint": {
    "pattern": "/register-response",
    "method": "POST"
  },
  "transformation": {
    "input": "JSON",
    "output": "JSON"
  },
  "inputTransforms": {
    "currentDate": "$now()",
    "sourcePatient": "$exists(requestBody.identifier) and $exists(requestBody.identifier[0]) and $exists(requestBody.identifier[0].value) ? {'patient': requestBody.identifier[0].value, 'facility': requestBody.identifier[0].system} : null",
    "pin": "$exists(requestBody.identifier) and $exists(requestBody.identifier[0]) and $count($filter(requestBody.identifier, function($v) {$contains($v.system, 'http://homeaffairs.sys')})) > 0 ? $filter(requestBody.identifier, function($v) {$contains($v.system, 'http://homeaffairs.sys')})[0].value : null",
    "firstName": "$exists(requestBody.name) and $exists(requestBody.name[0]) and $exists(requestBody.name[0].given[0]) ? requestBody.name[0].given[0] : null",
    "middleName": "$exists(requestBody.name) and $exists(requestBody.name[0]) and $exists(requestBody.name[0].given[1]) ? requestBody.name[0].given[1] : null",
    "surname": "$exists(requestBody.name) and $exists(requestBody.name[0]) ? requestBody.name[0].family : null",
    "sex": "$exists(requestBody.gender) ? requestBody.gender : null",
    "dob": "$exists(requestBody.birthDate) ? requestBody.birthDate : null",
    "birthTime": "$exists(requestBody._birthDate) and $exists(requestBody._birthDate.extension) and $exists(requestBody._birthDate.extension[0]) and $exists(requestBody._birthDate.extension[0].valueDateTime) ? requestBody._birthDate.extension[0].valueDateTime : null",
    "cellPhone": "$exists(requestBody.telecom) and $count($filter(requestBody.telecom, function($v) {$contains($v.system, 'phone')})) > 0 ? $filter(requestBody.telecom, function($v) {$contains($v.system, 'phone')}).value : null",
    "inkhundla": "$exists(requestBody.extension) and $exists(requestBody.extension[1]) ? requestBody.extension[1].valueCodeableConcept.text : null",
    "chiefdom": "$exists(requestBody.extension) and $exists(requestBody.extension[2]) ? requestBody.extension[2].valueCodeableConcept.text : null",
    "nationality": "$exists(requestBody.extension) and $exists(requestBody.extension[0].extension) and $exists(requestBody.extension[0].extension[0]) and $exists(requestBody.extension[0].extension[0].valueCodeableConcept) and $exists(requestBody.extension[0].extension[0].valueCodeableConcept.coding[0])and $exists(requestBody.extension[0].extension[0].valueCodeableConcept.coding[0].display) ? requestBody.extension[0].extension[0].valueCodeableConcept.coding[0].display : null",
    "city": "$exists(requestBody.address) and $exists(requestBody.address[0]) and $exists(requestBody.address[0].city) ? requestBody.address[0].city : null"
  },
  "inputMapping": {
    "transforms.sourcePatient": "sourceId",
    "transforms.pin": "demographicData.pin",
    "transforms.firstName": "demographicData.firstName",
    "transforms.middleName": "demographicData.middleName",
    "transforms.surname": "demographicData.surname",
    "transforms.sex": "demographicData.sex",
    "transforms.dob": "demographicData.dob",
    "transforms.cellPhone": "demographicData.cellPhone",
    "transforms.inkhundla": "demographicData.inkhundla",
    "transforms.chiefdom": "demographicData.chiefdom",
    "transforms.nationality": "demographicData.nationality",
    "transforms.city": "demographicData.city",
    "transforms.currentDate": "uniqueInteractionData.auxDateCreated"
  },
  "requests": {
    "response": {
      "id": "jempi",
      "primary": true,
      "config": {
        "method": "post",
        "headers": {
          "contentType": "application/fhir+json"
        },
        "url": "http://jempi-api:50000/JeMPI/crLink"
      }
    }
  }
}
