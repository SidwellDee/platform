{
  "name": "Search MPI Endpoint",
  "endpoint": {
    "pattern": "/mpi",
    "method": "GET"
  },
  "transformation": {
    "output": "JSON"
  },
  "inputTransforms": {
    "total": "$count(lookupRequests.jempiSearchAll.data.goldenRecords)",
    "entry": "$append([], $map(lookupRequests.jempiSearchAll.data.goldenRecords, function($v) {{'fullUrl': 'Patient/' & $v.uid, 'resource': {'resourceType': 'Patient','id': $v.uid,'name': {'given': [$v.demographicData.firstName,$v.demographicData.middleName],'family': $v.demographicData.surname},'address': [{'city': $v.demographicData.city}],'birthDate': $v.demographicData.dob,'telecom': [{'value': $v.demographicData.phoneNumber,'system': 'phone'}],'identifier': [{'use':'official','type':{'coding':[{'system':'http://localhost:3447/fhir/CodeSystem/SzPersonIdentificationsCS','code':'PI','display':'Personal ID Number'}]},'system': 'urn:homeaffairs:population-register','value': $v.demographicData.pin}],'gender': $v.demographicData.sex,'extension':[{'url':'http://localhost:3447/fhir/StructureDefinition/SzInkhundlaExtension','valueCodeableConcept':{'coding':[{'system':'http://localhost:3447/fhir/CodeSystem/SzTinkhundlaCS','code': $v.demographicData.inkhundla,'display':$v.demographicData.inkhundla}],'text':$v.demographicData.inkhundla}},{'url':'http://localhost:3447/fhir/StructureDefinition/SzChiefdomExtension','valueCodeableConcept':{'coding':[{'system':'http://localhost:3447/fhir/CodeSystem/SzChiefdomCS','code': $v.demographicData.chiefdom,'display':$v.demographicData.chiefdom}],'text':$v.demographicData.chiefdom}}]}}}))"
  },
  "inputMapping": {
    "constants.resourceType": "resourceType",
    "constants.type": "type",
    "transforms.total": "total",
    "transforms.entry": "entry"
  },
  "constants": {
    "resourceType": "Bundle",
    "type": "searchset"
  },
  "requests": {
    "lookup": [
      {
        "id": "jempiSearchAll",
        "config": {
          "method": "get",
          "headers": {
            "contentType": "application/json"
          },
          "params": {
            "query": {
              "family": {
                "path": "query.family"
              },
              "given": {
                "path": "query.given"
              },
              "telecom": {
                "path": "query.telecom"
              },
              "identifier": {
                "path": "query.identifier"
              },
              "gender": {
                "path": "query.gender"
              },
              "birthDate": {
                "path": "query.birthDate"
              },
              "address": {
                "path": "query.address"
              }
            }
          },
          "url": "http://openhim-mapping-mediator:3003/search-mpi-all"
        }
      }
    ]
  }
}
